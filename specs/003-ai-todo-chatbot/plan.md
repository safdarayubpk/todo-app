# Implementation Plan: AI-Powered Todo Chatbot (MCP Architecture)

**Branch**: `003-ai-todo-chatbot` | **Date**: 2025-12-29 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/003-ai-todo-chatbot/spec.md`
**Update**: MCP Architecture requirement added per hackathon mandate

## Summary

Implement an AI-powered chatbot that enables authenticated users to manage their todo lists through natural language conversations. The chatbot uses **OpenAI Agents SDK** for AI logic and **Official MCP SDK (FastMCP)** for task tools, with the agent connecting to MCP tools via the MCP protocol. Frontend uses OpenAI ChatKit for the chat UI.

**Key Architecture Change**: Task tools MUST be implemented as an MCP Server using the Official MCP SDK, replacing the current `@function_tool` implementation.

## Technical Context

**Language/Version**: Python 3.11+ (backend), TypeScript 5.x (frontend)
**Primary Dependencies**: FastAPI, OpenAI Agents SDK, Official MCP SDK (FastMCP), SQLModel, Next.js 15
**Storage**: Neon PostgreSQL (existing tasks table + new conversations/messages tables)
**Testing**: pytest (backend), Jest (frontend)
**Target Platform**: Vercel (frontend), HuggingFace Spaces (backend)
**Project Type**: Web application (frontend + backend)
**Performance Goals**: <5s for full response, <500ms first stream event
**Constraints**: User isolation required, MCP protocol for tools mandatory
**Scale/Scope**: Multi-user, ~100 concurrent users

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Spec-Driven Development | ✅ PASS | Spec updated with MCP requirements |
| II. AI-Only Implementation | ✅ PASS | All code generated by Claude |
| III. Iterative Evolution | ✅ PASS | Building on Phase II foundation |
| IV. Reusability and Modularity | ✅ PASS | MCP Server is modular, reusable |
| V. Security and Isolation | ✅ PASS | User ID required in all MCP tools |
| VI. Cloud-Native Readiness | ✅ PASS | MCP Server is containerizable |

## Project Structure

### Documentation (this feature)

```text
specs/003-ai-todo-chatbot/
├── spec.md              # Feature specification (updated for MCP)
├── plan.md              # This file
├── research.md          # MCP integration research
├── data-model.md        # Conversation/Message models
├── quickstart.md        # Setup guide
├── checklists/          # Quality checklists
│   └── requirements.md  # Spec validation
└── tasks.md             # Implementation tasks
```

### Source Code (repository root)

```text
backend/
├── app/
│   ├── mcp_server/           # NEW: MCP Server module
│   │   ├── __init__.py
│   │   ├── server.py         # FastMCP server with 5 tools
│   │   └── tools.py          # Tool implementations (optional split)
│   ├── chatkit/              # UPDATED: Agent uses MCP
│   │   ├── __init__.py
│   │   ├── agent.py          # Agent with MCPServerStdio
│   │   ├── context.py        # JWT session management
│   │   └── server.py         # Chat endpoint with streaming
│   ├── models/
│   │   ├── task.py           # Existing Task model
│   │   ├── conversation.py   # NEW: Conversation model
│   │   └── message.py        # NEW: Message model
│   └── main.py
└── tests/
    ├── test_mcp_tools.py     # MCP tool unit tests
    └── test_chat_integration.py

frontend/
├── app/
│   ├── chat/
│   │   └── page.tsx          # Chat page (existing)
│   └── api/
│       └── chatkit/
│           └── session/
│               └── route.ts  # Session endpoint (existing)
├── components/
│   └── chat/
│       └── TodoChat.tsx      # Chat component (existing)
└── lib/
    └── chatkit/
        └── config.ts         # ChatKit config (existing)
```

**Structure Decision**: Extend existing web application structure. Add `mcp_server/` module for MCP Server, update `chatkit/` to use MCP integration.

## Architecture Design

### Component Diagram

```
┌─────────────────┐     ┌──────────────────────────────────────────────┐
│  Frontend       │     │              FastAPI Backend                  │
│  (Next.js)      │     │                                              │
│                 │     │  ┌────────────────────────────────────────┐  │
│  TodoChat.tsx   │────▶│  │         POST /chatkit                  │  │
│  (ChatKit)      │ SSE │  │         (Streaming Response)            │  │
│                 │◀────│  └───────────────┬────────────────────────┘  │
│                 │     │                  │                           │
│                 │     │                  ▼                           │
│                 │     │  ┌────────────────────────────────────────┐  │
│                 │     │  │     OpenAI Agents SDK                  │  │
│                 │     │  │     Agent + Runner                     │  │
│                 │     │  │     mcp_servers=[mcp_server]           │  │
│                 │     │  └───────────────┬────────────────────────┘  │
│                 │     │                  │ MCPServerStdio            │
│                 │     │                  │ (stdio transport)         │
│                 │     │                  ▼                           │
│                 │     │  ┌────────────────────────────────────────┐  │
│                 │     │  │     MCP Server (FastMCP)               │  │
│                 │     │  │     @mcp.tool() decorators             │  │
│                 │     │  │     - add_task                         │  │
│                 │     │  │     - list_tasks                       │  │
│                 │     │  │     - complete_task                    │  │
│                 │     │  │     - delete_task                      │  │
│                 │     │  │     - update_task                      │  │
│                 │     │  └───────────────┬────────────────────────┘  │
└─────────────────┘     └──────────────────│──────────────────────────┘
                                           │
                                           ▼
                        ┌──────────────────────────────────────────────┐
                        │              Neon PostgreSQL                  │
                        │  - tasks (existing)                          │
                        │  - conversations (new)                       │
                        │  - messages (new)                            │
                        └──────────────────────────────────────────────┘
```

### Sequence Diagram: Chat Message Flow

```
User        Frontend        FastAPI         Agent SDK       MCP Server       Database
 │              │               │               │               │               │
 │──message────▶│               │               │               │               │
 │              │──POST /chatkit─▶              │               │               │
 │              │               │──create agent──▶              │               │
 │              │               │               │──MCPServerStdio│               │
 │              │               │               │◀──connected────│               │
 │              │               │──Runner.run_streamed──────────▶               │
 │              │               │               │──list_tasks────▶              │
 │              │               │               │               │──SELECT───────▶
 │              │               │               │               │◀──tasks───────│
 │              │               │               │◀──task list────│               │
 │              │◀──SSE stream──│◀──stream events               │               │
 │◀──display────│               │               │               │               │
```

## Implementation Phases

### Phase 0: MCP Server Setup
1. Create `backend/app/mcp_server/` module
2. Implement FastMCP server with 5 tools
3. Test MCP server independently
4. Update dependencies in pyproject.toml

### Phase 1: Agent MCP Integration
1. Update `backend/app/chatkit/agent.py` to use `MCPServerStdio`
2. Remove `@function_tool` implementations from `tools.py`
3. Update system prompt with user_id injection
4. Test agent with MCP tools

### Phase 2: Conversation Persistence
1. Create Conversation and Message SQLModel models
2. Add database migration for new tables
3. Update chat endpoint to persist messages
4. Implement conversation history retrieval

### Phase 3: Integration Testing
1. End-to-end test all 5 MCP tools
2. Verify user isolation
3. Test streaming responses
4. Verify real-time sync with dashboard

## Complexity Tracking

| Item | Justification | Alternative Rejected |
|------|---------------|---------------------|
| MCP Server subprocess | Required by hackathon | Direct function tools (simpler but not allowed) |
| User ID in system prompt | MCP tools are stateless | Context injection (not supported by MCP) |

## Dependencies

### New Backend Dependencies

```toml
# pyproject.toml additions
[project.dependencies]
mcp = ">=1.0.0"  # Official MCP SDK
# openai-agents already installed
```

### Migration Steps

1. Install MCP SDK: `uv add mcp`
2. Create MCP Server module
3. Update agent to use MCPServerStdio
4. Remove old @function_tool implementations
5. Test full integration

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| MCP subprocess latency | Medium | Low | Connection pooling |
| User ID injection fails | Low | High | Validate in each tool |
| Streaming compatibility | Low | Medium | Test with existing ChatKit |
| Database connection sharing | Low | Medium | Use async sessions |

## Success Criteria Mapping

| Spec Criteria | Implementation |
|---------------|----------------|
| SC-001: <5s response | MCP tools + streaming |
| SC-002: 90% accuracy | System prompt + MCP tools |
| SC-003: Clarification | Agent instructions |
| SC-004: <2s sync | Event-based refresh |
| SC-005: User isolation | user_id in all MCP tools |
| SC-006: Mobile 320px | Existing ChatKit UI |
| SC-007: <1s feedback | Streaming response |
| SC-008: 5+ interactions | 5 MCP tools |
| SC-009: Chat history | Conversation persistence |
| SC-010: Error handling | Try/catch in tools |

## Next Steps

1. Run `/sp.tasks` to generate detailed implementation tasks
2. Execute tasks in order following MCP architecture
3. Test each phase before proceeding
4. Create demo script for verification
